services:
  github-runner:
    # Build custom image with Claude Code Review dependencies pre-installed
    # This builds from the Dockerfile which extends myoung34/github-runner:latest
    build:
      context: .
      dockerfile: Dockerfile
    image: synology-github-runner:latest  # Tag for the built image
    container_name: github-runner
    restart: unless-stopped

    # Health check with generous startup time for post-reboot recovery
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'Runner.Listener' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # Give runner 2 minutes to start after reboot

    # Resource limits (Synology-compatible)
    # Configure these in .env file
    mem_limit: ${RUNNER_MEMORY:-5g}
    memswap_limit: ${RUNNER_MEMORY:-5g}
    cpu_shares: ${RUNNER_CPU_SHARES:-1536}  # Higher priority (default is 1024)

    # Security hardening
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all Linux capabilities
    cap_add:
      - CHOWN      # Needed for runner file management
      - SETGID     # Needed for user/group operations
      - SETUID     # Needed for user/group operations
      - DAC_OVERRIDE  # Needed for file access
    tmpfs:
      - /tmp:mode=1777,size=${TMPFS_TMP_SIZE:-1g}  # Secure temporary storage
      - /run:mode=755,size=${TMPFS_RUN_SIZE:-512m}  # Secure runtime storage

    environment:
      # GitHub Configuration (from .env file)
      - RUNNER_NAME=${RUNNER_NAME:-synology-general-runner}
      - REPO_URL=${REPO_URL}
      - ACCESS_TOKEN=${GITHUB_PAT}

      # Labels for flexible workflow selection
      - LABELS=${LABELS:-self-hosted,linux,synology,general}

      # Optional: Gradle optimization for Java/Kotlin builds
      - GRADLE_OPTS=${GRADLE_OPTS:--Xmx3g -XX:+UseG1GC -XX:MaxGCPauseMillis=200}

      # Runner behavior
      # IMPORTANT: Use host path for Docker-in-Docker compatibility
      # This allows tools like Qodana to bind mount workspace subdirectories
      - RUNNER_WORKDIR=${RUNNER_WORKDIR:-/volume1/docker/github-runner/workspace}
      # RUNNER_SCOPE: 'repo' for single repository, 'org' for organization-wide
      - RUNNER_SCOPE=${RUNNER_SCOPE:-repo}

      # Restart reliability: Delay startup to allow network/volumes to be ready
      # Particularly important after NAS reboot
      - STARTUP_DELAY_SECONDS=${STARTUP_DELAY_SECONDS:-30}

    volumes:
      # Mount workspace at the same path on host and container
      # This ensures Docker-in-Docker bind mounts work correctly
      - ${RUNNER_WORKDIR:-/volume1/docker/github-runner/workspace}:${RUNNER_WORKDIR:-/volume1/docker/github-runner/workspace}
      - /volume1/docker/github-runner/cache:/cache
      - /var/run/docker.sock:/var/run/docker.sock  # Allow runner to use Docker

    # No ports needed - runner connects outbound to GitHub
