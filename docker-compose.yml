services:
  github-runner:
    image: myoung34/github-runner:latest
    container_name: github-runner
    restart: unless-stopped

    # Resource limits (Synology-compatible)
    mem_limit: 5g
    memswap_limit: 5g
    cpu_shares: 1536  # Higher priority (default is 1024)

    # Security hardening
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all Linux capabilities
    cap_add:
      - CHOWN      # Needed for runner file management
      - SETGID     # Needed for user/group operations
      - SETUID     # Needed for user/group operations
      - DAC_OVERRIDE  # Needed for file access
    tmpfs:
      - /tmp:mode=1777,size=1g  # Secure temporary storage
      - /run:mode=755,size=512m  # Secure runtime storage

    environment:
      # GitHub Configuration (from .env file)
      - RUNNER_NAME=${RUNNER_NAME:-synology-general-runner}
      - REPO_URL=${REPO_URL}
      - ACCESS_TOKEN=${GITHUB_PAT}

      # Labels for flexible workflow selection
      - LABELS=${LABELS:-self-hosted,linux,synology,general}

      # Optional: Gradle optimization for Java/Kotlin builds
      - GRADLE_OPTS=${GRADLE_OPTS:--Xmx3g -XX:+UseG1GC -XX:MaxGCPauseMillis=200}

      # Runner behavior
      - RUNNER_WORKDIR=/workspace
      - RUNNER_SCOPE=repo

    volumes:
      - /volume1/docker/github-runner/workspace:/workspace
      - /volume1/docker/github-runner/cache:/cache
      - /var/run/docker.sock:/var/run/docker.sock  # Allow runner to use Docker

    # No ports needed - runner connects outbound to GitHub
